<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Game</title>

    <link rel="stylesheet" href="/public/pong.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Floating binary numbers -->
    <div class="binary-stream" style="top: 13%; left: 42%;">01100110</div>
    <div class="binary-stream" style="top: 32%; left: 70%;">01110101</div>
    <div class="binary-stream" style="top: 83%; left: 80%;">01110101</div>
    <div class="binary-stream" style="top: 24%; left: 23%;">01101011</div>
    <div class="binary-stream" style="top: 66%; left: 70%;">00100000</div>
    <div class="binary-stream" style="top: 10%; left: 86%;">01110011</div>
    <div class="binary-stream" style="top: 40%; left: 20%;">01101111</div>
    <div class="binary-stream" style="top: 76%; left: 45%;">01100011</div>
    <div class="binary-stream" style="top: 20%; left: 6%;">01101001</div>
    <div class="binary-stream" style="top: 60%; left: 12%;">01100101</div>
    <div class="binary-stream" style="top: 87%; left: 22%;">01110100</div>
    <div class="binary-stream" style="top: 47%; left: 95%;">01111001</div>

    <header>
        <a href="success.html" class="back-button">← Back to Games</a>
        <h1>PONG</h1>
    </header>

    <main>
        <button id="fullscreenBtn" class="fullscreen-btn" onclick="toggleFullscreen()">⛶ Fullscreen (F)</button>

        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div class="controls">
            <p id="controlsText"></p>
        </div>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const gameMode = urlParams.get('mode') || '2player';
        const botDifficulty = urlParams.get('difficulty') || 'medium';
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const paddleWidth = 10;
        const paddleHeight = 100;
        const ballSize = 10;

        let player1 = {
            x: 20,
            y: canvas.height / 2 - paddleHeight / 2,
            width: paddleWidth,
            height: paddleHeight,
            score: 0,
            dy: 0
        };

        let player2 = {
            x: canvas.width - 30,
            y: canvas.height / 2 - paddleHeight / 2,
            width: paddleWidth,
            height: paddleHeight,
            score: 0,
            dy: 0
        };

        let ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            dx: 3,
            dy: 3,
            size: ballSize,
            speed: 3,
            maxSpeed: 8
        };

        let gameRunning = false;
        let countdown = 0;
        let keys = {};
        let canRestart = true;
        
        // Bot settings
        const botSpeeds = {
            easy: 3,
            medium: 4.5,
            hard: 6
        };
        const botSpeed = gameMode === 'bot' ? botSpeeds[botDifficulty] : 0;
        
        // Update controls text
        const lang = localStorage.getItem('language') || 'en';
        const controlsEl = document.getElementById('controlsText');
        if (gameMode === 'bot') {
            controlsEl.textContent = lang === 'de' 
                ? 'Steuerung: W/S | Drücke LEERTASTE zum Starten' 
                : 'Controls: W/S | Press SPACE to start';
        } else {
            controlsEl.textContent = lang === 'de'
                ? 'Spieler 1: W/S | Spieler 2: Pfeiltasten | Drücke LEERTASTE zum Starten'
                : 'Player 1: W/S | Player 2: Arrow Keys | Press SPACE to start';
        }

        function drawRect(x, y, w, h, color) {
            ctx.fillStyle = color;
            ctx.shadowBlur = 10;
            ctx.shadowColor = color;
            ctx.fillRect(x, y, w, h);
            ctx.shadowBlur = 0;
        }

        function drawCircle(x, y, radius, color) {
            ctx.fillStyle = color;
            ctx.shadowBlur = 15;
            ctx.shadowColor = color;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function drawNet() {
            ctx.strokeStyle = '#00FF66';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function drawScore() {
            ctx.font = '48px VT323';
            ctx.fillStyle = '#00FF66';
            ctx.textAlign = 'center';
            ctx.fillText(player1.score, canvas.width / 4, 60);
            ctx.fillText(player2.score, (canvas.width / 4) * 3, 60);
        }

        function updatePaddles() {
            if (keys['w'] && player1.y > 0) player1.y -= 6;
            if (keys['s'] && player1.y < canvas.height - player1.height) player1.y += 6;
            
            if (gameMode === 'bot') {
                // Bot AI
                const ballCenter = ball.y;
                const paddleCenter = player2.y + player2.height / 2;
                
                if (ballCenter < paddleCenter - 10) {
                    player2.y -= botSpeed;
                } else if (ballCenter > paddleCenter + 10) {
                    player2.y += botSpeed;
                }
                
                player2.y = Math.max(0, Math.min(canvas.height - player2.height, player2.y));
            } else {
                // 2-player controls
                if (keys['ArrowUp'] && player2.y > 0) player2.y -= 6;
                if (keys['ArrowDown'] && player2.y < canvas.height - player2.height) player2.y += 6;
            }
        }

        function updateBall() {
            ball.x += ball.dx;
            ball.y += ball.dy;

            if (ball.y - ball.size < 0 || ball.y + ball.size > canvas.height) {
                ball.dy = -ball.dy;
            }

            if (ball.x - ball.size < player1.x + player1.width &&
                ball.y > player1.y &&
                ball.y < player1.y + player1.height) {
                ball.dx = Math.abs(ball.dx);
                
                // Gradually speed up (max 8)
                if (ball.speed < ball.maxSpeed) {
                    ball.speed += 0.2;
                    ball.dx = ball.dx > 0 ? ball.speed : -ball.speed;
                    ball.dy = ball.dy > 0 ? ball.speed : -ball.speed;
                }
            }

            if (ball.x + ball.size > player2.x &&
                ball.y > player2.y &&
                ball.y < player2.y + player2.height) {
                ball.dx = -Math.abs(ball.dx);
                
                if (ball.speed < ball.maxSpeed) {
                    ball.speed += 0.2;
                    ball.dx = ball.dx > 0 ? ball.speed : -ball.speed;
                    ball.dy = ball.dy > 0 ? ball.speed : -ball.speed;
                }
            }

            if (ball.x < 0) {
                player2.score++;
                resetBall();
            }
            if (ball.x > canvas.width) {
                player1.score++;
                resetBall();
            }
        }

        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.speed = 3;
            ball.dx = (Math.random() > 0.5 ? 1 : -1) * 3;
            ball.dy = (Math.random() > 0.5 ? 1 : -1) * 3;
            countdown = 3;
            gameRunning = false;
            
            let countdownTimer = setInterval(() => {
                countdown--;
                if (countdown === 0) {
                    clearInterval(countdownTimer);
                    gameRunning = true;
                }
            }, 1000);
        }

        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawNet();
            drawScore();
            drawRect(player1.x, player1.y, player1.width, player1.height, '#00FF66');
            drawRect(player2.x, player2.y, player2.width, player2.height, '#00FFFF');
            drawCircle(ball.x, ball.y, ball.size, '#FF5555');
            
            // Draw countdown
            if (countdown > 0) {
                ctx.font = '96px VT323';
                ctx.fillStyle = '#FFD700';
                ctx.textAlign = 'center';
                ctx.fillText(countdown, canvas.width / 2, canvas.height / 2);
            }
        }

        function gameLoop() {
            if (!gameRunning) return;

            updatePaddles();
            updateBall();
            draw();

            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            if (!canRestart) return;
            
            canRestart = false;
            player1.score = 0;
            player2.score = 0;
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.speed = 3;
            ball.dx = 3;
            ball.dy = 3;
            countdown = 3;
            
            let countdownTimer = setInterval(() => {
                countdown--;
                if (countdown === 0) {
                    clearInterval(countdownTimer);
                    gameRunning = true;
                    canRestart = true;
                }
            }, 1000);
            
            gameLoop();
        }

        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;

            if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                if (!gameRunning) {
                    startGame();
                }
            }

            if (e.key === 'f' || e.key === 'F') {
                toggleFullscreen();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Touch controls for mobile
        let touchY = 0;
        let isTouchingLeft = false;

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            touchY = touch.clientY;
            const rect = canvas.getBoundingClientRect();
            isTouchingLeft = touch.clientX - rect.left < canvas.width / 2;
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const canvasY = touch.clientY - rect.top;
            
            if (isTouchingLeft) {
                player1.y = canvasY - player1.height / 2;
                player1.y = Math.max(0, Math.min(canvas.height - player1.height, player1.y));
            } else {
                player2.y = canvasY - player2.height / 2;
                player2.y = Math.max(0, Math.min(canvas.height - player2.height, player2.y));
            }
        });

        canvas.addEventListener('touchend', () => {
            if (!gameRunning) {
                startGame();
            }
        });

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                canvas.requestFullscreen().catch(err => {
                    console.log('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Start message
        draw();
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.font = '48px VT323';
        ctx.fillStyle = '#00FF66';
        ctx.textAlign = 'center';
        ctx.fillText('PONG', canvas.width / 2, canvas.height / 2 - 40);
        ctx.font = '32px VT323';
        ctx.fillText('Press SPACE to start', canvas.width / 2, canvas.height / 2 + 20);
    </script>
</body>

</html>
